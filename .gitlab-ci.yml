stages:
  - test
  - build
  - publish

variables:
  IMAGE_NAME: $CI_REGISTRY_IMAGE:latest
  DOCKERHUB_IMAGE: $DOCKERHUB_USERNAME/streamlit-bike:latest

test:
  stage: test
  image: python:3.10
  script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pytest -q || echo "No tests found, skipping."


build:
  image: docker:24
  stage: build
  services:
    - docker:24-dind
  script:
    - docker build -t $IMAGE_NAME .
    - docker tag $IMAGE_NAME $DOCKERHUB_IMAGE
  artifacts:
    expire_in: 1h
    paths:
      - .

publish-gitlab:
  image: docker:24
  stage: publish
  services:
    - docker:24-dind
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" $CI_REGISTRY --password-stdin
    - docker push $IMAGE_NAME
  only:
    - main

publish-dockerhub:
  image: docker:24
  stage: publish
  services:
    - docker:24-dind
  script:
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - docker push $DOCKERHUB_IMAGE
  only:
    - main
